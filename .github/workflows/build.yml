name: Build MaxCoin

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install boost openssl@3 berkeley-db@4 qt@5 miniupnpc

      - name: Build daemon
        run: |
          cd src
          make -f makefile.osx USE_UPNP=- -j$(sysctl -n hw.ncpu)

      - name: Build Qt wallet
        run: |
          /opt/homebrew/opt/qt@5/bin/qmake "USE_UPNP=-" maxcoin-qt.pro
          make -j$(sysctl -n hw.ncpu)

      - name: Package macOS
        run: |
          mkdir -p release
          cp src/maxcoind release/
          zip -r release/MaxCoin-Qt-macOS-ARM64.zip MaxCoin-Qt.app

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-macos-arm64
          path: release/

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libboost-all-dev \
            libdb-dev libdb++-dev libminiupnpc-dev \
            qtbase5-dev qttools5-dev-tools libqrencode-dev

      - name: Build daemon
        run: |
          cd src
          make -f makefile.unix USE_UPNP=- -j$(nproc)

      - name: Build Qt wallet
        run: |
          qmake "USE_UPNP=-" maxcoin-qt.pro
          make -j$(nproc)

      - name: Package Linux
        run: |
          mkdir -p release
          cp src/maxcoind release/
          cp maxcoin-qt release/
          chmod +x release/maxcoind release/maxcoin-qt
          tar -czvf release/maxcoin-linux-x64.tar.gz -C release maxcoind maxcoin-qt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-linux-x64
          path: release/maxcoin-linux-x64.tar.gz

  build-windows:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 g++-mingw-w64-x86-64 \
            autoconf automake libtool pkg-config

      - name: Download Windows dependencies
        run: |
          mkdir -p deps
          cd deps

          # Download pre-built Windows Boost
          wget -q https://boostorg.jfrog.io/artifactory/main/release/1.81.0/source/boost_1_81_0.tar.gz
          tar -xzf boost_1_81_0.tar.gz
          cd boost_1_81_0
          ./bootstrap.sh
          echo "using gcc : mingw : x86_64-w64-mingw32-g++ ;" > user-config.jam
          ./b2 --user-config=user-config.jam toolset=gcc-mingw target-os=windows \
            address-model=64 link=static threading=multi \
            --with-system --with-filesystem --with-program_options --with-thread \
            --with-chrono --prefix=$HOME/boost-mingw install || true
          cd ../..

      - name: Download OpenSSL for Windows
        run: |
          cd deps
          wget -q https://www.openssl.org/source/openssl-3.0.12.tar.gz
          tar -xzf openssl-3.0.12.tar.gz
          cd openssl-3.0.12
          ./Configure mingw64 --cross-compile-prefix=x86_64-w64-mingw32- \
            --prefix=$HOME/openssl-mingw no-shared
          make -j$(nproc)
          make install_sw || true
          cd ../..

      - name: Build Windows daemon
        run: |
          cd src
          make -f makefile.mingw USE_UPNP=- \
            BOOST_LIB_PATH=$HOME/boost-mingw/lib \
            BOOST_INCLUDE_PATH=$HOME/boost-mingw/include \
            OPENSSL_LIB_PATH=$HOME/openssl-mingw/lib64 \
            OPENSSL_INCLUDE_PATH=$HOME/openssl-mingw/include \
            -j$(nproc) || echo "Windows build may need makefile adjustments"

      - name: Package Windows
        run: |
          mkdir -p release
          cp src/maxcoind.exe release/ 2>/dev/null || echo "Daemon not built"
          # Note: Qt cross-compile is complex, daemon-only for now

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-windows-x64
          path: release/
        if: always()

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            maxcoin-macos-arm64/*
            maxcoin-linux-x64/*
            maxcoin-windows-x64/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
