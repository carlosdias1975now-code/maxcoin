name: Build MaxCoin

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # macOS builds disabled - use local compile scripts instead
  # build-macos:
  #   See maxcoin-wallet-compile.command and maxcoin-qt-wallet-compile.command

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libboost-all-dev \
            libdb-dev libdb++-dev libminiupnpc-dev \
            qtbase5-dev qttools5-dev-tools libqrencode-dev

      - name: Build daemon
        run: |
          cd src
          # Build dependencies first
          cd leveldb && make libleveldb.a libmemenv.a && cd ..
          cd cryptopp && make libcryptopp.a && cd ..
          # Build - add boost_chrono which makefile.unix doesn't include
          sed -i 's/-lboost_thread/-lboost_thread -lboost_chrono/' makefile.unix
          make -f makefile.unix USE_UPNP=- -j$(nproc)

      - name: Build Qt wallet
        run: |
          qmake "USE_UPNP=-" "LIBS+=-lboost_chrono" maxcoin-qt.pro
          make -j$(nproc)

      - name: Package Linux
        run: |
          mkdir -p release
          cp src/maxcoind release/
          cp maxcoin-qt release/
          chmod +x release/maxcoind release/maxcoin-qt
          tar -czvf release/maxcoin-linux-x64.tar.gz -C release maxcoind maxcoin-qt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-linux-x64
          path: release/maxcoin-linux-x64.tar.gz

  build-windows:
    runs-on: ubuntu-22.04
    continue-on-error: true  # Windows cross-compile is experimental
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 g++-mingw-w64-x86-64

      - name: Note about Windows builds
        run: |
          echo "Windows cross-compilation requires significant makefile modifications."
          echo "For now, Windows users can build natively with MSYS2."
          echo "See README.md for MSYS2 build instructions."
          mkdir -p release
          echo "Windows build requires MSYS2 - see README.md" > release/WINDOWS_BUILD_INSTRUCTIONS.txt

      - name: Upload Windows placeholder
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-windows-x64
          path: release/

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            maxcoin-linux-x64/*
            maxcoin-windows-x64/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
