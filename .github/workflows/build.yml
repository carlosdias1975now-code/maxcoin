name: Build MaxCoin

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # macOS builds disabled - use local compile scripts instead
  # build-macos:
  #   See maxcoin-wallet-compile.command and maxcoin-qt-wallet-compile.command

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libboost-all-dev \
            libdb-dev libdb++-dev libminiupnpc-dev \
            qtbase5-dev qttools5-dev-tools libqrencode-dev

      - name: Build daemon
        run: |
          cd src
          # Build dependencies first
          cd leveldb && make libleveldb.a libmemenv.a && cd ..
          cd cryptopp && make libcryptopp.a && cd ..
          # Add boost_chrono to makefile.unix LIBS line
          echo 'LIBS += -lboost_chrono' >> makefile.unix
          make -f makefile.unix USE_UPNP=- -j$(nproc)

      - name: Build Qt wallet
        run: |
          qmake "USE_UPNP=-" "LIBS+=-lboost_chrono" maxcoin-qt.pro
          make -j$(nproc)

      - name: Package Linux
        run: |
          mkdir -p release
          cp src/maxcoind release/
          cp maxcoin-qt release/
          chmod +x release/maxcoind release/maxcoin-qt
          tar -czvf release/maxcoin-linux-x64.tar.gz -C release maxcoind maxcoin-qt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-linux-x64
          path: release/maxcoin-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-db
            mingw-w64-x86_64-qt5
            mingw-w64-x86_64-qrencode
            make
            git

      - name: Build daemon
        shell: msys2 {0}
        run: |
          # Debug: List available Boost libraries we need
          echo "=== Available Boost libraries ==="
          ls -la /mingw64/lib/libboost_system* 2>/dev/null || echo "boost_system: header-only (not needed)"
          ls -la /mingw64/lib/libboost_filesystem* 2>/dev/null || echo "boost_filesystem: NOT FOUND"
          ls -la /mingw64/lib/libboost_program_options* 2>/dev/null || echo "boost_program_options: NOT FOUND"
          ls -la /mingw64/lib/libboost_thread* 2>/dev/null || echo "boost_thread: NOT FOUND"
          ls -la /mingw64/lib/libboost_chrono* 2>/dev/null || echo "boost_chrono: NOT FOUND"

          cd src
          # Build LevelDB for Windows
          cd leveldb
          TARGET_OS=NATIVE_WINDOWS make libleveldb.a libmemenv.a || echo "LevelDB build attempted"
          cd ..
          # Build Crypto++ with byte fix
          cd cryptopp
          make CXXFLAGS="-DCRYPTOPP_NO_GLOBAL_BYTE=1 -std=c++14" libcryptopp.a || echo "Cryptopp build attempted"
          cd ..

          # Compile all source files directly
          mkdir -p obj
          CXXFLAGS="-std=c++14 -O2 -w -D_MT -DWIN32 -D_WINDOWS -DBOOST_THREAD_USE_LIB -DBOOST_SPIRIT_THREADSAFE -DBOOST_BIND_GLOBAL_PLACEHOLDERS -DCRYPTOPP_NO_GLOBAL_BYTE=1"
          INCLUDES="-I. -Ileveldb/include -Ileveldb/helpers -I/mingw64/include -I/mingw64/include/db4"

          for src in alert version checkpoints netbase addrman crypter key db init keystore main net protocol bitcoinrpc rpcdump rpcnet rpcmining rpcwallet rpcblockchain rpcrawtransaction script sync util wallet walletdb noui hash bloom leveldb txdb; do
            echo "Compiling $src.cpp..."
            g++ -c $CXXFLAGS $INCLUDES -o obj/$src.o $src.cpp
          done

          # Compile keccak.c (SHA-3 implementation) as C
          echo "Compiling keccak.c..."
          gcc -c -O2 -w -DWIN32 -I. -o obj/keccak.o keccak.c

          # Link with explicit Boost library paths
          # Note: boost_system is header-only since Boost 1.69, no library needed
          echo "Linking maxcoind.exe..."
          g++ -static-libgcc -static-libstdc++ -o maxcoind.exe \
            obj/*.o \
            -Lleveldb -Lcryptopp -L/mingw64/lib \
            -lleveldb -lcryptopp -lmemenv \
            -lboost_filesystem-mt -lboost_program_options-mt \
            -lboost_thread-mt -lboost_chrono-mt \
            -ldb_cxx -lssl -lcrypto \
            -lws2_32 -lmswsock -lshlwapi -ladvapi32 -lrpcrt4 -luuid \
            -lole32 -loleaut32 -lcomctl32 -lshell32 -lwinmm -lgdi32 \
            -lcomdlg32 -lwinspool -lkernel32 -luser32

      - name: Build Qt wallet
        shell: msys2 {0}
        run: |
          # Configure and build Qt wallet for MSYS2
          /mingw64/bin/qmake-qt5.exe \
            "USE_UPNP=-" \
            "QMAKE_CXXFLAGS+=-DCRYPTOPP_NO_GLOBAL_BYTE=1 -std=c++14" \
            "INCLUDEPATH+=/mingw64/include /mingw64/include/db4" \
            "LIBS+=-L/mingw64/lib -lboost_system-mt -lboost_filesystem-mt -lboost_program_options-mt -lboost_thread-mt -lboost_chrono-mt" \
            maxcoin-qt.pro
          make -j$(nproc)

      - name: Package Windows
        shell: msys2 {0}
        run: |
          mkdir -p release
          echo "=== Looking for binaries ==="
          find . -name "*.exe" -type f 2>/dev/null | head -20
          # Copy daemon
          cp src/maxcoind.exe release/ 2>/dev/null || echo "No daemon found"
          # Copy Qt wallet (may be in different locations)
          cp maxcoin-qt.exe release/ 2>/dev/null || \
          cp release/maxcoin-qt.exe release/ 2>/dev/null || \
          cp debug/maxcoin-qt.exe release/ 2>/dev/null || echo "No Qt found"
          echo "=== Release contents ==="
          ls -la release/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-windows-x64
          path: release/

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            maxcoin-linux-x64/*
            maxcoin-windows-x64/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
