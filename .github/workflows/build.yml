name: Build MaxCoin

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install boost openssl@3 qt@5 miniupnpc

      - name: Build Berkeley DB 4.8 from source
        run: |
          curl -LO https://download.oracle.com/berkeley-db/db-4.8.30.NC.tar.gz
          tar -xzf db-4.8.30.NC.tar.gz
          cd db-4.8.30.NC/build_unix
          # Fix for clang on modern macOS
          sed -i '' 's/__atomic_compare_exchange/__atomic_compare_exchange_db/' ../dbinc/atomic.h || true
          ../dist/configure --prefix=/usr/local/opt/berkeley-db@4 --enable-cxx --disable-shared
          make -j$(sysctl -n hw.ncpu)
          sudo make install

      - name: Build daemon
        run: |
          cd src
          make -f makefile.osx USE_UPNP=- BDB_INCLUDE_PATH=/usr/local/opt/berkeley-db@4/include BDB_LIB_PATH=/usr/local/opt/berkeley-db@4/lib -j$(sysctl -n hw.ncpu)

      - name: Build Qt wallet
        run: |
          /opt/homebrew/opt/qt@5/bin/qmake "USE_UPNP=-" "BDB_INCLUDE_PATH=/usr/local/opt/berkeley-db@4/include" "BDB_LIB_PATH=/usr/local/opt/berkeley-db@4/lib" maxcoin-qt.pro
          make -j$(sysctl -n hw.ncpu)

      - name: Package macOS
        run: |
          mkdir -p release
          cp src/maxcoind release/
          zip -r release/MaxCoin-Qt-macOS-ARM64.zip MaxCoin-Qt.app

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-macos-arm64
          path: release/

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libboost-all-dev \
            libdb-dev libdb++-dev libminiupnpc-dev \
            qtbase5-dev qttools5-dev-tools libqrencode-dev

      - name: Build daemon
        run: |
          cd src
          make -f makefile.unix USE_UPNP=- -j$(nproc)

      - name: Build Qt wallet
        run: |
          qmake "USE_UPNP=-" maxcoin-qt.pro
          make -j$(nproc)

      - name: Package Linux
        run: |
          mkdir -p release
          cp src/maxcoind release/
          cp maxcoin-qt release/
          chmod +x release/maxcoind release/maxcoin-qt
          tar -czvf release/maxcoin-linux-x64.tar.gz -C release maxcoind maxcoin-qt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-linux-x64
          path: release/maxcoin-linux-x64.tar.gz

  build-windows:
    runs-on: ubuntu-22.04
    continue-on-error: true  # Windows cross-compile is experimental
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 g++-mingw-w64-x86-64

      - name: Note about Windows builds
        run: |
          echo "Windows cross-compilation requires significant makefile modifications."
          echo "For now, Windows users can build natively with MSYS2."
          echo "See README.md for MSYS2 build instructions."
          mkdir -p release
          echo "Windows build requires MSYS2 - see README.md" > release/WINDOWS_BUILD_INSTRUCTIONS.txt

      - name: Upload Windows placeholder
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-windows-x64
          path: release/

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            maxcoin-macos-arm64/*
            maxcoin-linux-x64/*
            maxcoin-windows-x64/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
