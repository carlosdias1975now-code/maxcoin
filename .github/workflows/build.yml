name: Build MaxCoin

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # macOS builds disabled - use local compile scripts instead
  # build-macos:
  #   See maxcoin-wallet-compile.command and maxcoin-qt-wallet-compile.command

  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libboost-all-dev \
            libdb-dev libdb++-dev libminiupnpc-dev \
            qtbase5-dev qttools5-dev-tools libqrencode-dev

      - name: Build daemon
        run: |
          cd src
          # Build dependencies first
          cd leveldb && make libleveldb.a libmemenv.a && cd ..
          cd cryptopp && make libcryptopp.a && cd ..
          # Add boost_chrono to makefile.unix LIBS line
          echo 'LIBS += -lboost_chrono' >> makefile.unix
          make -f makefile.unix USE_UPNP=- -j$(nproc)

      - name: Build Qt wallet
        run: |
          qmake "USE_UPNP=-" "LIBS+=-lboost_chrono" maxcoin-qt.pro
          make -j$(nproc)

      - name: Package Linux
        run: |
          mkdir -p release
          cp src/maxcoind release/
          cp maxcoin-qt release/
          chmod +x release/maxcoind release/maxcoin-qt
          tar -czvf release/maxcoin-linux-x64.tar.gz -C release maxcoind maxcoin-qt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-linux-x64
          path: release/maxcoin-linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-boost
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-db
            mingw-w64-x86_64-qt5
            mingw-w64-x86_64-qrencode
            make
            git

      - name: Build daemon
        shell: msys2 {0}
        run: |
          cd src
          cd leveldb && make libleveldb.a libmemenv.a && cd ..
          cd cryptopp && make libcryptopp.a && cd ..
          make -f makefile.mingw USE_UPNP=- -j$(nproc) || echo "Daemon build attempted"

      - name: Build Qt wallet
        shell: msys2 {0}
        run: |
          qmake "USE_UPNP=-" maxcoin-qt.pro
          make -j$(nproc) || echo "Qt build attempted"

      - name: Package Windows
        shell: msys2 {0}
        run: |
          mkdir -p release
          cp src/maxcoind.exe release/ 2>/dev/null || echo "No daemon"
          cp release/maxcoin-qt.exe release/ 2>/dev/null || echo "No Qt"
          echo "Windows build" > release/BUILD_INFO.txt

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maxcoin-windows-x64
          path: release/

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            maxcoin-linux-x64/*
            maxcoin-windows-x64/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
